----------------------------------------------
Exercise 4.3. Area and uncertainty estimation
----------------------------------------------

The final step of calculating the sample-based estimates of error and area is taking the map areas (generated in Exercise 4.1), and your verification data points from our data collection (Exercise 4.2), conducted according to the response design rules (Exercise 4.1) and using statistics to output the final estimates of area and uncertainty.

In Part 1, we provide an optional description of error matrices, also called confusion matrices. This provides the underlying theory for using the SEPAL “Stratified estimator--Analysis” tool to conduct the area and uncertainty estimation. This tool quantifies the agreement between the validation reference points and the map product, providing information on how well the class locations were predicted.
Please note that you will need to upload your collected data from CEO to Sepal using the directions found in Part 0 of Exercise 4.1. If you used the CEO-SEPAL bridge, you must log out of CEO for the “Import CEO Project” link to work.

+-----------------------------------+-----------------------------------+
| Objectives                        | Prerequisites                     |
+===================================+===================================+
| Create area estimates for         | Completed verification data,      |
| your classification               | or reference data (Exercise 4.2)  |
+-----------------------------------+-----------------------------------+
| Create uncertainty/error          | Map areas generated by your       |
| estimates for your classification | sampling design (Exercise 4.1)    |
+-----------------------------------+-----------------------------------+

Part 1. [Optional] Understanding the error matrix
--------------------------------------------------

A common tool to quantify agreement is the error matrix (sometimes called a confusion matrix). The error matrix organizes the acquired sample data in a way that summarizes key results and aids the quantification of accuracy and area. This is a simple cross-tabulation that compares the (algorithm assigned) map category labels to the (human assigned) reference category labels (your validation classification). The count for each pairwise combination are included in the blue and yellow cells in the following example.

.. image:: images/confusion_matrix_example.png
   :alt: A confusion matrix example.
   :align: center

|

* The main diagonal of the error matrix (blue cells) includes the count of the number of correct classifications.
* The off-diagonal elements (yellow cells) show map classification errors.
* The user’s accuracy can be quantified by dividing the number of correctly classified plots by the sum of the plots classified as the mapped class. For the forest class in the example above, this is 17 correctly identified points divided by 19 total forest plots. User’s accuracies for each class are shown in the orange cells. User’s accuracy is the complement of errors of commission (sites that are classified as forest in the map, but are not actually forest).
* The producer’s accuracy can be quantified by dividing the number of correctly classified plots by the sum of the plots classified as the mapped class in the validation reference sample. For the forest class in the example above, this is 17 correctly identified points divided by 20 samples that were classified as forest from the reference data. Producer’s accuracies for each class are shown in the pink cells. Producer’s accuracy is the complement of errors of omission (sites that are not classified as forest in the map that are actually forest).


For your own data, calculate an error matrix following the above guidelines:

.. image:: images/example_error_matrix.png
   :alt: An example error matrix.
   :align: center

|

Here’s a completed example for a project using 4 classes:

.. image:: images/example_error_matrix_4class.png
   :alt: Example error matrix for a 4 class project.
   :align: center

|

In this example, the user’s accuracy for Forest is 94.7%; so the error of commission is 5.3%. The user’s accuracy for water is 90%, which means the error of commission is 10%. What this means is that according to the reference data, the map creator mapped 5.3% of Forest land cover in the wrong class and 10% of water in the wrong class. The producer’s accuracy for Forest is 75%, meaning the error of omission is 25%. The producer’s accuracy for water is 90%, so the error of omission is 10%. This means that 25% of the forest reference samples were mapped in the wrong land cover class, while only 10% of water was mapped in the wrong class. Calculate the errors of omission and commission for Other and Cloud land cover classes.

Once the error matrix is created, the area estimation becomes straightforward. Essentially, we use the frequency of these errors of omission and commission for each map class to calculate updated map areas based on our knowledge of how likely each class is to be classified as something else. We can also calculate the uncertainties for the total area of each class.

At the heart of the analysis is the implementation of an unbiased area estimator. Different estimators can be implemented to assess accuracy. In the next part, you will use a stratified estimation since you have a sample stratified by the discrete map classes.

Part 2. [Optional] Preparing your CEO collected data for analysis in SEPAL
---------------------------------------------------------------------------

1. Open the .csv file you downloaded from Collect Earth Online in Exercise 4.2 Part 3. It will probably have a name like “ceo-project-name-sample-data-yyyy-mm-dd.csv”.
2. Inspect the column data.

  a. You should have a column named “PL_MAP_CLASS” that consists of numeric values. These are the classes assigned by the classification.
  b. You should also have a column with your question about the correct map class as the column header. In this example, it is “IS THIS FOREST OR NON-FOREST”. These are the classes you assigned manually in CEO based on map imagery. This will either be numeric (1 or 2) or text (Forest and Non-forest) depending on how you set up your Collect Earth Online project.

3. If your column for the correct map class is numeric, skip to step 5 below.
4. If your column for the correct map class is text, you will need to either:

  a. Check that your text column matches exactly the Legend Labels you added during sample design (Exercise 4.1).
  b. Check that capitalization is the same, e.g. Non-forest and Non-forest not Non-forest and non-forest.
  c. OR Create another column with the associated numeric value.

    i. First, create a new column and name it COLLECTED_CLASS.
    ii. In the formula cell, type: =IF([text column letter]2="Forest",1,2). For this example, the text column letter is U.
    iii. This will use an if statement to assign the number 1 to sample plots you assigned the value “Forest” to, and the number 2 to other plots (here, plots labeled Non-forest). If you have more than two classes, you will need to use nested IF statements.
    iv. Press enter. You should now see either a 1 or a 2 populate the column. Double check that it is the correct value.

  d. Fill the entire column.

.. image:: images/example_dataset.png
   :alt: An example dataset
   :width: 400
   :align: center

|

5. Save your .csv file.
6. Upload your .csv file to SEPAL using the directions in Part 0: Uploading files to SEPAL of this Module.

Part 3. Using the stratified estimator in SEPAL
------------------------------------------------

The aim of this stratified sampling design tool is to analyze results from a stratified sampling design that can be used for area estimates. The idea is to combine a map (used as a stratification of the landscape of interest) with a visual map interpretation of samples to produce an area estimation.

The concept is derived from map accuracy assessment principles: characterized frequency of errors (omission and commission) for each map class may be used to compute area estimates and also to estimate the uncertainties (confidence intervals) for the areas for each class.

1. First, open the Stratified Area Estimator-Analysis Tool

  a. In the Apps SEPAL window select Stratified Area Estimator - Analysis.
  b. This tool is very similar to the Design tool that you used to create your stratified sample.

    i. You will land on the **Introduction** page which allows you to choose your language and provides background information on the tool. Note that Reference and Documents are in the same place as the Design tool.
    ii. The pages that contain the necessary steps for the workflow are on the left side of the screen and need to be completed sequentially.

.. image:: images/stratified_estimator_analysis_tool.png
   :alt: The stratified estimator analysis tool.
   :align: center

|

2. Select the **Inputs** page on the left side of the screen. You will see two data requirements under the **Select input files** section.

  a. **Reference Data** this refers to the table that you classified and exported in the previous section. It will contain a column that identifies the map output class for each point as well as a column for the value from the image interpreter (validation classification).

    i. For projects completed in CEO: Select the **Reference data** button and navigate to the .csv file you downloaded from CEO and then uploaded to SEPAL in Exercise 4.3 Part 2.
    ii. For projects completed in CEO-SEPAL bridge:

      1. Check that you are logged out of the Collect Earth Online website.
      2. Paste the URL from your CEO-SEPAL bridge project into the field marked **CEO url.** You can also click the **Paste CEO url from clipboard** button.
      3. Click **Import CEO project.**
      4. This will populate the input file for the Reference data as well as the column names.

  b. **Area data** this is a CSV that was automatically created during the Stratified Area Estimator--Design workflow. It contains area values for each mapped land cover class.

    i. Click the **Area data** button.
    ii. Open the **sae_design_AmazonClassification** folder, or the folder labeled sae_design_your-name-here if you did not call your classification AmazonClassification.
    iii. As a reminder, if you exported your classification to the SEPAL workspace, the file will be in your SEPAL downloads folder. (downloads > classification folder > sae_design_AmazonClassification).
    iv. Within this folder, select **area_rast.csv** (see image below).

.. image:: images/add_classification.png
   :alt: Adding the classification
   :width: 450
   :align: center

|

3. Next, you will need to adjust some parameters so that the tool recognizes the column names for your reference data and area data that contain the necessary information for your accuracy assessment. You should now see a populated **Required input** panel on the right side of the screen.

  a. Choose the column with the reference data information.

    i. For projects completed in CEO: This will either be your question name or the new column name you created in Part 2 above. Here it is COLLECTED_CLASS following the directions in Part 2.
    ii. For projects completed in CEO-SEPAL: ref_code

  b. Choose the column with the map data information

    i. For projects completed in CEO: PL_MAP_CLASS
    ii. For projects completed in CEO-SEPAL: map_code

  c. Choose the map area column from the area file—map_area
  d. Choose the class column from the area file—map_code or map_edited_class

    i. The map_edited_class has the names you entered manually during the design phase, while the map_code has the numeric class codes.
    ii. For projects completed in CEO: Use map_code if you have a column in your reference data. If you use map_edited_class you must make sure that capitalization.
    iii. For projects completed in CEO-SEPAL, use map_code.

  e. You can add a **Display data** column to enable validation on the fly. You can choose any column from your CEO or CEO-SEPAL project. We recommend either your map class (e.g. PL_MAP_CLASS) or your reference data class (e.g. question name column). This example uses a CEO project.

.. image:: images/required_input_fields.png
   :alt: The required input fields.
   :width: 450
   :align: center

|

4. Once you have set these input parameters, select **Check** on the left side of the window.

  a. This page will simply plot your samples on a world map.
  b. Fix the locations of your plots by specifying the correct columns to use as the X and Y coordinates in the map.
  c. Click the drop down menus and select the appropriate coordinate columns for X and Y coordinates. X coordinate should be LON; Y coordinate should be LAT.

5. Next, click the **Results** page on the left side of the screen.

  a. The **Results** page will display a few different accuracy statistics, including a **Confusion Matrix, Area Estimates,** and a **Graph** of area estimates with confidence intervals.
  b. The Confusion Matrix enables you to assess the agreement of the map and validation data sets.

    i. The rows represent your assignments while the columns represent the map classifier’s.
    ii. The diagonal represents the number of samples that are in agreement, while the off diagonal cells represent points that were not mapped correctly (or potentially not interpreted correctly).

.. image:: images/confusion_matrix_output_sepal.png
   :alt: The confusion matrix output by SEPAL.
   :width: 450
   :align: center

|

6. Typically you would have to create the confusion table yourself and calculate the accuracies, however, the SAE-Analysis tool does this for you.

  a. If you completed Part 1, how does the SAE-Analysis tool’s calculations compare with your own?
  b. You can download confusion matrix as tabular data (.csv) using the button.

7. Under **Area estimates,** the table shows you the area estimates, and producer’s and user’s accuracies, all of which were calculated from the error matrix and the class areas (sample weights) from the map product you are assessing.

  a. Estimations are broken up into simple and stratified estimates, each of which has its own confidence interval.
  b. In this exercise we collected validation data using a stratified sample, so the values we need to use are the stratified random values.
  c. Note that all area estimates are in map units.
  d. You can change your desired **confidence interval** using the slider at the top of the panel.
  e. You can Download area estimates as tabular data (.csv) using the button.

.. image:: images/area_estimate.png
   :alt: The area estimates screen in SEPAL.
   :align: center

|

8. The **Graph** plots area estimates based on: map pixel count, stratified random sample, simple random sample, unbiased stratified random and direct estimate stratified random.

  a. In this exercise we collected validation data using a stratified sample, so the values we need to use are the stratified random values.
  b. Need to define unbiased stratified random and direct estimate stratified random.
  c. Note that the Map pixel count value differs from these stratified random sample estimates. This shows how using a map pixel count is a poor estimation of actual area.

.. image:: images/area_estimate_graph.png
   :alt: A graph of the area estimates based on different sample design.
   :width: 450
   :align: center

|

**Congratulations! You successfully completed this exercise. You now know how to perform an accuracy assessment and generate area estimates in SEPAL.**
